{% extends "public/base.html" %}
{% load static %}
{% block meta_title %}Work Zilla | Billing{% endblock %}
{% block meta_description %}Review billing status, payments, and invoices for your Work Zilla subscriptions.{% endblock %}
{% block body_class %}account-page{% endblock %}

{% block content %}
<section class="section">
  <div class="site-container account-layout">
    <div class="account-header">
      <h1 class="section-title">Billing</h1>
    </div>
    {% include "public/partials/account_tabs.html" %}

    <div class="account-content card p-4">
        {% if messages %}
          {% for message in messages|slice:"-1:" %}
            <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %}">
              {{ message }}
            </div>
          {% endfor %}
        {% endif %}
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
          <div>
            <h2 class="section-title">Billing Details</h2>
          </div>
          <form method="get" class="d-flex align-items-center gap-2">
            <label class="text-secondary">Product</label>
            <select class="form-select form-select-sm" name="product" onchange="this.form.submit()">
              <option value="all" {% if billing_product_slug == "all" %}selected{% endif %}>All</option>
              {% for product in billing_products %}
                <option value="{{ product.slug }}" {% if billing_product_slug == product.slug %}selected{% endif %}>
                  {{ product.name }}
                </option>
              {% endfor %}
            </select>
          </form>
        </div>

        <div class="table-responsive mt-3">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Product</th>
                <th>Plan</th>
                <th>Billing Cycle</th>
                <th>Type</th>
                <th>Amount</th>
                <th>Paid On</th>
                <th>Status</th>
                <th>PDF</th>
              </tr>
            </thead>
            <tbody>
              {% for transfer in approved_transfers %}
                <tr>
                  <td>{{ transfer.plan.product.name|default:"Work Suite" }}</td>
                  <td>{{ transfer.plan.name|default:"-" }}</td>
                  <td>{{ transfer.billing_cycle|title }}</td>
                  <td>{{ transfer.request_type|default:"Base"|title }}</td>
                  <td>{{ transfer.currency }} {{ transfer.amount }}</td>
                  <td>{% if transfer.paid_on %}{{ transfer.paid_on|date:"d M Y" }}{% else %}-{% endif %}</td>
                  <td><span class="badge bg-success">{{ transfer.status|title|default:"Approved" }}</span></td>
                  <td>
                    {% if transfer.id %}
                      <a class="btn btn-outline btn-sm" href="/api/dashboard/billing/invoice/{{ transfer.id }}" target="_blank" rel="noopener noreferrer">
                        Download
                      </a>
                    {% else %}
                      -
                    {% endif %}
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="8">No billing records available.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <h3 class="section-title mt-4">Pending Bank Transfers</h3>
        <div class="table-responsive mt-2">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Product</th>
                <th>Plan</th>
                <th>Billing Cycle</th>
                <th>Type</th>
                <th>Amount</th>
                <th>Requested</th>
                <th>Description</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for transfer in pending_transfers %}
                <tr>
                  <td>{{ transfer.plan.product.name|default:"Work Suite" }}</td>
                  <td>{{ transfer.plan.name|default:"-" }}</td>
                  <td>{{ transfer.billing_cycle|title }}</td>
                  <td>{{ transfer.request_type|title }}</td>
                  <td>{{ transfer.currency }} {{ transfer.amount }}</td>
                  <td>{{ transfer.created_at|date:"d M Y" }}</td>
                  <td>{{ transfer.notes|default:"-"|truncatechars:120 }}</td>
                  <td><span class="badge bg-warning text-dark">{{ transfer.status|title }}</span></td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="8">No pending transfers.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <h3 class="section-title mt-4">Billing Activity</h3>
        <div class="table-responsive mt-2">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Type</th>
                <th>Product</th>
                <th>Plan</th>
                <th>Billing Cycle</th>
                <th>Status</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
              {% for row in billing_activity %}
                <tr>
                  <td>{{ row.type }}</td>
                  <td>{{ row.product_name|default:branding.display_name }}</td>
                  <td>{{ row.plan }}</td>
                  <td>{{ row.billing_cycle|title }}</td>
                  <td>{{ row.status|title }}</td>
                  <td>{% if row.date %}{{ row.date|date:"d M Y" }}{% else %}-{% endif %}</td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="6">No billing activity yet.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <h3 class="section-title mt-4">Company Billing Details</h3>
        {% include "public/partials/billing_profile_form.html" %}
    </div>
  </div>
</section>
{% endblock %}
